test_name=ue4-reflections
test_exec_time=60

# WARNING: Requires libframetime: https://github.com/clbr/libframetime

ue4-reflections_run() {
    cd "$UE4_REFLECTIONS_FOLDER" # Set this variable in test_options.sh

    rm /tmp/frametime.log 2> /dev/null

    for (( c=0; c<$1; c++ ))
    do
        DISPLAY=:0 vblank_mode=0 LIBFRAMETIME_FILE=/tmp/frametime.log LD_PRELOAD=$LIBFRAMETIME64_SO taskset 1 timeout $test_exec_time ./ReflectionsSubway -NOSOUND -ResX=$UE4_WINDOW_SIZE_X -ResY=$UE4_WINDOW_SIZE_Y > /dev/null 2>&1
    done

    # read back the result, skip the first frames since they are the loading frames
    cat /tmp/frametime.log | cut -d ' ' -f 2 | tail -n +10 | awk '{print 1000000/$0}'
}
